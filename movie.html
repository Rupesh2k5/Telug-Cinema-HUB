<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Details</title>
  <link rel="icon" type="image/jpg" href="images.jpg">
  <link rel="stylesheet" href="css/style.css">
  <script src="config.js"></script>
</head>
<body>

<div id="movie-detail" class="movie-detail-container"></div>

<script>
const params = new URLSearchParams(window.location.search);
const movieId = params.get("movieId");
const type = params.get("type");
const tmdbKey = window.TMDB_KEY;

const ottLinks = {
  "Netflix": "https://www.netflix.com/in/",
  "Amazon Prime Video": "https://www.primevideo.com/",
  "Disney Plus": "https://www.disneyplus.com/",
  "Hotstar": "https://www.hotstar.com/in",
  "Sony LIV": "https://www.sonyliv.com/",
  "ZEE5": "https://www.zee5.com/",
  "Apple TV+": "https://tv.apple.com/",
  "HBO Max": "https://www.hbomax.com/",
  "Voot": "https://www.voot.com/"
};

/* =========================
   TRAILER (MULTI PRIORITY)
========================= */
async function getTMDBVideoLink(movieId, movie) {
  const res = await fetch(
    `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${tmdbKey}`
  );
  const data = await res.json();

  if (data.results && data.results.length > 0) {
    const priority = [
      "Trailer",
      "Teaser",
      "Glimpse",
      "Motion Poster",
      "Clip",
      "Featurette"
    ];

    for (const p of priority) {
      const video = data.results.find(
        v => v.site === "YouTube" && v.type === p
      );
      if (video) {
        return {
          link: `https://www.youtube.com/watch?v=${video.key}`,
          text: `Watch Official ${p}`
        };
      }
    }
  }

  const language = movie.original_language || "telugu";
  const searchPrompts = [
    `${movie.title} Movie Trailer`,
    `${movie.title} Release Trailer`,
    `${movie.title} Movie Teaser`,
    `${movie.title} ${language} Glimpse`,
    `${movie.title} Official Trailer`,
    `${movie.title} Theatrical Trailer`,
    `${movie.title} Trailer`
  ];

  return {
    link: `https://www.youtube.com/results?search_query=${encodeURIComponent(searchPrompts.join(" OR "))}`,
    text: "Search Trailer on YouTube"
  };
}

/* =========================
   FULL MOVIE SEARCH
========================= */
function getFullMovieLink(movie) {
  const queries = [
    `${movie.title} full movie telugu`,
    `${movie.title} full length HD movie`,
    `${movie.title} super hit movie`,
    `${movie.title} blockbuster movie`,
    `${movie.title} ${movie.release_date?.slice(0,4)} full movie`,
    `${movie.title} hero movie full`
  ];

  return `https://www.youtube.com/results?search_query=${encodeURIComponent(queries.join(" OR "))}`;
}

/* =========================
   MAIN LOAD
========================= */
async function loadMovieDetails() {
  const detailRes = await fetch(
    `https://api.themoviedb.org/3/movie/${movieId}?api_key=${tmdbKey}&language=en-US`
  );
  const movie = await detailRes.json();

  const creditsRes = await fetch(
    `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbKey}&language=en-US`
  );
  const credits = await creditsRes.json();

  const providerRes = await fetch(
    `https://api.themoviedb.org/3/movie/${movieId}/watch/providers?api_key=${tmdbKey}`
  );
  const providers = await providerRes.json();

  const directors = credits.crew.filter(c => c.job === "Director").map(c => c.name).join(", ");
  const music = credits.crew.filter(c => c.job === "Original Music Composer").map(c => c.name).join(", ");
  const cast = credits.cast.slice(0, 10).map(c => c.name).join(", ");

  const trailer = await getTMDBVideoLink(movieId, movie);
  const fullMovieLink = getFullMovieLink(movie);

  let ottHTML = "Not available on OTT";
  if (providers.results && providers.results.IN && providers.results.IN.flatrate) {
    ottHTML = providers.results.IN.flatrate.map(p => {
      const url = ottLinks[p.provider_name] || "#";
      return `<a href="${url}" target="_blank">${p.provider_name}</a>`;
    }).join(", ");
  }
  let songsHTML = "";
if (type === "music") {
  const songSearch = encodeURIComponent(
    `${movie.title} Telugu full songs`
  );

  songsHTML = `
    <hr>
    <p><strong>Songs:</strong></p>
    <ul>
      <li>Original soundtrack composed by <strong>${music || "Music Director"}</strong></li>
      <li>Search query: "${movie.title} Telugu full songs"</li>
    </ul>
    <p>
      <a href="https://www.youtube.com/results?search_query=${songSearch}" target="_blank">
        â–¶ Watch Songs on YouTube
      </a>
    </p>
  `;
}


  document.getElementById("movie-detail").innerHTML = `
    <h1>${movie.title} (${movie.release_date ? movie.release_date.split("-")[0] : ""})</h1>
    <img class="poster" src="${movie.poster_path ? 'https://image.tmdb.org/t/p/w300' + movie.poster_path : 'https://via.placeholder.com/300x450?text=No+Image'}">

    <p><strong>Overview:</strong> ${movie.overview || "No description available."}</p>
    <p><strong>Genres:</strong> ${movie.genres.map(g => g.name).join(", ")}</p>
    <p><strong>Director:</strong> ${directors || "N/A"}</p>
    <p><strong>Music:</strong> ${music || "N/A"}</p>
    <p><strong>Cast:</strong> ${cast || "N/A"}</p>

    

    <p><strong>Trailer:</strong>
      ${trailer ? `<a href="${trailer.link}" target="_blank">${trailer.text}</a>` : "Not Found"}
    </p>

    <p><strong>Full Movie:</strong>
      <a href="${fullMovieLink}" target="_blank">Search on YouTube</a>
    </p>

    <p><strong>OTT Platforms:</strong> ${ottHTML}</p>

    ${songsHTML}
  `;
}

loadMovieDetails();
</script>

</body>
</html>
